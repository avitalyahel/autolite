#!/usr/local/bin/python3
'''
autolite control tool.

Usage:
    actl task list [-v | -vv]
    actl task (read | delete) <name> [-v | -vv]
    actl task create <name> (--continuous | --daily) [-v | -vv]
    actl reset [-v | -vv]

Arguments:
    <name>      Name of task.

Options:
    -h --help               Show this screen.
    --version               Show version.
    -v --verbose            Higher verbosity messages.
    -C, --continuous        Set task schedule to 'continuous'.
    -D, --daily             Set task schedule to 'daily'.
'''

import os
import sys

import db
from verbosity import set_verbosity

SELF_ABS_PATH = os.path.realpath(__file__)
SELF_FULL_DIR = os.path.dirname(SELF_ABS_PATH)
SELF_SUB_DIR = os.path.basename(SELF_FULL_DIR)

PACKAGE_NAME = SELF_SUB_DIR


def actl(arguments):
    db.init()

    if arguments['task']:
        task(arguments)

    elif arguments['reset']:
        if input('Confirm Db reset (N|y): ') == 'y':
            db.init(drop=True)
            print('Db have been reset!')

        else:
            print('Did not reset.')


def task(arguments):
    if arguments['list']:
        task_list()

    elif arguments['create']:
        db.create_task(**_task_create_kwargs(arguments))

    else:
        try:
            if arguments['read']:
                print(repr(db.read_task(name=arguments['<name>'])))

            elif arguments['delete']:
                db.delete_task(name=arguments['<name>'])

        except NameError as exc:
            print(PACKAGE_NAME, 'Error:', exc)
            sys.exit(1)


def _task_create_kwargs(arguments):
    result = dict(name=arguments['<name>'], state='pending')

    if arguments['--daily']:
        result.update(dict(schedule='daily'))

    elif arguments['--continuous']:
        result.update(dict(schedule='continuous'))

    return result


def task_list():
    db.g_table_info.tasks.sep = '\t'
    print(str(db.g_table_info.tasks).title())
    print(db.list_tasks(colsep='\t'))


if __name__ == '__main__':
    from docopt import docopt
    with open(os.path.join(SELF_FULL_DIR, 'version')) as ver_file:
        arguments = docopt(__doc__, version=ver_file.read())

    if arguments['--verbose']:
        set_verbosity(arguments['--verbose'])

    if arguments['--verbose'] > 1:
        print(arguments)

    sys.exit(actl(arguments))
