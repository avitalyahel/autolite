#!/usr/local/bin/python3

import schema

__doc__ = '''
autolite control tool.

Usage:
    actl (task | system) list [-v | -vv]
    actl task create <name> ({sched_flags}) [-v | -vv]
                     [--command=<exe>] [--setup=<exe>] [--teardown=<exe>]
    actl (task | system) (read | delete) <name> [-v | -vv]
    actl task set <name> schedule ({sched_flags}) [-v | -vv]
    actl task set <name> (setup | command | teardown) <exe> [-v | -vv]
    actl task reset <name> [-v | -vv] [--force]
    actl system create <name> [--ip <ip>] [-v | -vv]
                     [--installer=<exe>] [--cleaner=<exe>] [--monitor=<exe>] [--config=<exe>]
    actl system set <name> ip <ip> [-v | -vv]
    actl system set <name> (installer | cleaner | monitor | config) <exe> [-v | -vv]
    actl system (acquire | install | clean | monitor | config) <name> [-v | -vv]
    actl system release <name> [--force] [-v | -vv]
    actl reset [-v | -vv]

Options:
    -h --help               Show this screen.
    --version               Show version.
    -v --verbose            Higher verbosity messages.
    --force                 Force the command.
{sched_opts}
    --command <exe>         Task command executable.
    --setup <exe>           Task setup executable (returns bool).
    --teardown <exe>        Task teardown executable.
    --installer <exe>       System installation executable.
    --cleaner <exe>         System cleaning executable.
    --monitor <exe>         System monitoring executable.
    --config <exe>          System configuration executable.
'''.format(
    sched_flags=' | '.join(('--' + sched) for sched in schema.SCHEDULES),
    sched_opts='\n'.join(
        '    -{upchar}, --{sched:17} Set task schedule to \'{sched}\'.'.format(sched=sched, upchar=sched[0].upper())
        for sched in schema.SCHEDULES),
)

import os
import sys

import db
import consts
import actl_task
import actl_system
from verbosity import set_verbosity, get_verbosity_level

SELF_ABS_PATH, SELF_FULL_DIR, SELF_SUB_DIR = consts.get_self_path_dir(__file__)


def actl(arguments):
    db.init()

    if arguments['task']:
        actl_task.menu(arguments)

    elif arguments['system']:
        actl_system.menu(arguments)

    elif arguments['reset']:
        if input('Confirm Db reset (N|y): ') == 'y':
            db.init(drop=True)
            print('Db have been reset!')

        else:
            print('Did not reset.')


if __name__ == '__main__':
    from docopt import docopt

    with open(os.path.join(SELF_FULL_DIR, 'version')) as ver_file:
        arguments = docopt(__doc__, version=ver_file.read())

    set_verbosity(arguments['--verbose'])

    if get_verbosity_level() > 1:
        print(arguments)

    sys.exit(actl(arguments))
